20150327:
http://www.yiichina.com/doc/guide/2.0/start-workflow
http://www.yiiframework.com/download/
http://www.yiichina.com/doc/guide


http://localhost:8084/index.php?r=entry/index
http://localhost:8084/index.php?r=admin/entry/index
Yii::trace('AAA');

yii2中文显示问题，显示为乱码？
app\controllers\entry\EntryController为何不起作用？->http://localhost:8084/index.php?r=admin/entry/index
能否有多个入口脚本？

20150330:
<?php var_dump(__DIR__)?>
<?php var_dump(dirname(__DIR__))?>
<?= __DIR__?>
<?php echo __DIR__?>

http://php.net/manual/en/

设置时区：
<?php 
    date_default_timezone_set('PRC');
    echo date('Y-m-d H:i:s')
    ?>
<?php var_dump($this);?>
 $this->layout='@app/views/layouts/manager.php';
throw new \yii\base\Exception();
throw new \yii\web\NotFoundHttpException;
 \yii\web\User()与app\models\User的区别？
http://localhost:8084/index.php?r=entry/add-user

//能否绑定多个对象

 <?= $form->field($model, 'name') ->label('姓名:') ?> 
 等价于
 <input type="text" id="entryform-name" class="form-control" name="EntryForm[name]">
 ，关键是name="EntryForm[name]"需要一致，这样controller都可以正确接收到值
 
controller参数为数组：  
http://localhost:8084/index.php?r=entry/add-users&id[0]=3&id[1]=4&id[3]=5

20150331:
——————————————————————————————————
YII2.0 如何去掉URL中的index.php？
1、apache的httpd.conf中去掉LoadModule rewrite_module modules/mod_rewrite.so注释；
2、http.conf网站设置AllowOverride None改为AllowOverride All
3、yii2应用程序框架中'components'增加：
'urlManager' => [
    		'enablePrettyUrl' => true,
    		'showScriptName' => false,//隐藏index.php
    		//'enableStrictParsing' => false,
    		//'suffix' => '.html',//后缀，如果设置了此项，那么浏览器地址栏就必须带上.html后缀，否则会报404错误
    		'rules' => [
    			//'<controller:\w+>/<action:\w+>'=>'<controller>/<action>',
    			],
    		],
4、在index.php同级目录中增加.htaccess文件，内容如下：
Options +FollowSymLinks
IndexIgnore */*
RewriteEngine on

# if a directory or a file exists, use it directly
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# otherwise forward it to index.php
RewriteRule . index.php
————————————————————————

http://localhost:8084/entry/index      		

return $this->renderPartial('index', ['model' => $model]);

foreach ($model as $key => $value) {
	echo $key.'->'.$value.'</br>';
}

echo ($request->post("EntryForm")["name"]);

20150401:
在应用配置中增加:
'modules' => [
    'admin' => [
        'class' => 'app\modules\admin\Module',
    ],
]
http://localhost:8084/admin/default/index

yii的多语言配置：
————————————————————————————————————————————————————————
<?php echo \Yii::t('app', '测试中文');?>
<?php echo \Yii::t('app', 'name_label');?>
Yii::$app->language='zh-CN';
1、在web.php中配置
'i18n' => [
    			'translations' => [
    				'app*' => [
    							'class' => 'yii\i18n\PhpMessageSource',
    							//'basePath' => '@app/messages',
    							//'sourceLanguage' => 'en-US',
    							'fileMap' => [
    									'app' => 'app.php',
    									'app/error' => 'error.php',
    						],
    					],
    			],
    	],
2、增加文件@app/messages/zh-CN/app.php,如果为ru-RU则增加文件@app/messages/ru-RU/app.php；

3、输入内容
return [
		'name_label'=>'姓名',
		'email_label'=>'邮箱',
];
——————————————————————————————————————————————————————————
Yii::$app->getSession()->get($key)
Yii::$app->getRequest()->get($key);
Yii::$app->response->redirect("/site/index");

yii与jquery?

Url的解析？
Log如何输出到文件？->配置log组件输出到文件。
Activerecord行为的作用？
事件的作用？
系统预定义的别名在哪个文件中定义？
Db事务处理？
Jquery ui如何使用？
文件上传？


20150402:
composer安装：
1) windows:
C:\bin>php -r "readfile('https://getcomposer.org/installer');" | php
创建空的composer.bat
C:\bin>echo @php "%~dp0composer.phar" %*>composer.bat
C:\Users\username>composer -V
2) linuix:
curl -sS https://getcomposer.org/installer | php
or
php -r "readfile('https://getcomposer.org/installer');" | php

yii安装与升级：
php composer.phar create-project yiisoft/yii2-app-basic basic 2.0.3
php composer.phar create-project yiisoft/yii2-app-advanced advanced 2.0.3
php composer.phar require yiisoft/yii2 2.0.3
php composer.phar require --prefer-dist yiisoft/yii2 2.0.3 


window环境下更新至最新版本：
composer require yiisoft/yii2 2.0.3

yii2-jui安装：
php composer.phar create-project yiisoft/yii2-jui
或者
在composer.json的加入"require": {"yiisoft/yii2-jui": "~2.0.0"}

yii2-captcha安装：
php composer.phar require --prefer-dist mdmsoft/yii2-captcha "*"
或者
在composer.json的加入"require": {"mdmsoft/yii2-captcha": "*"}

bower-asset/jquery-ui: 1.11.*@stable
<?php var_dump($model->name)?>
 <?php 
    	echo DatePicker::widget(
    		[
    			'name'  => 'from_date',
    ])?>

create database yii;
create user yii identified by 'yii';
grant all privileges on yii.* to yii@localhost identified by 'yii';    	

grant all privileges on lulucms.* to yii@localhost identified by 'yii';  

在filter中统一设置controller的layout:
Yii::$app->controller->layout='@app/views/layouts/manager.php';


2015-04-03:
/* $connection =Yii::$app->db;		
		$trans = $connection->beginTransaction();
		try {
			
			$trans->commit();
		} catch (Exception $e) {
			$trans ->rollBack();
		} */

$connection =Yii::$app->db;				
		$connection->open();
		$tables= $connection->schema->getTableNames();		
		$command = $connection->createCommand("select * from t_drp_material_type where id = :id");
// 		$command->addColumn($table, $column, $type)
// 		$command->createTable($table, $columns)
		$command->bindValue(":id", 1);
		$results= $command->query();
		$connection->close();
				
通过配置[[yii\db\Connection]]可以实现数据库复制和读写分离
->如何配置？
crud:
Model Class:
app\models\DrpMaterialType
app\models\system\AdInfo

Search Model Class:
app\models\DrpMaterialTypeSearch

Controller Class:
app\modules\admin\controllers\DrpMaterialTypeController
app\modules\admin\controllers\system\AdInfoController

View Path:
@app/modules/admin/views/drp-material-type
@app/modules/admin/views/system/ad-info


gii Code Template增加

DrpMaterialType::findBySql这个函数貌似有问题，加入条件时，条件不起作用？

如何将sql查询出的结果写入到activerecord中？

http://ysk.dlysmc.com/new/mobile.html
itms-services://?action=download-manifest&url=https://app.boruicx.com/yunshang/yunshangke.plist


2015-04-07:
输出model对象
id:<?=$model->id?></br>
code:<?=$model->code?></br>
name:<?=$model->name?></br>

输出数组
id:<?=$model['id']?></br>
code:<?=$model['code']?></br>
name:<?=$model['name']?></br>

foreach ($model as $key => $value) {
// 	var_dump($key);
	var_dump($value);
}

view:
<?php foreach ($model as $key => $value) {?>
<tr>
	<td><?=$value['id']?></td>
	<td><?=$value['code']?></td>
	<td><?=$value['name']?></td>
</tr>
<?php } ?>

云商客：
1、系统登录，并记住密码
2、我的消息（消息与专题）
3、个人中心
3.1 会员等级
3.2 基本资料（
问题：如何认证我的资料？
银行卡的作用是什么？
我的资金托管在什么地方？
结算时如何提取到我的银行卡？
财务通账号的作用是什么？）




http://t.cn/RAxwqZ9
->
http://test.ysk.dlysmc.com/wap.php/reg/index/invite_mobile/13724346621


http://ysk.dlysmc.com/new/mobile.html

微店主站：
http://t.cn/RAxw5D3

操作手册：
http://www.xmgasy.com/yswd/index.html


腾付通
易宝支付

1\t_ad_info
http://localhost:8085/index.php?r=admin/system/ad-info/index


app\models\product\ProductType
app\modules\admin\controllers\product\ProductTypeController
@app/modules/admin/views/product/product-type
http://localhost:8085/index.php?r=admin/product/product-type/index

app\models\product\Product
app\modules\admin\controllers\product\ProducController
@app/modules/admin/views/product/product
http://localhost:8085/index.php?r=admin/product/product/index

app\models\vip\Vip
app\modules\admin\controllers\vip\VipController
@app/modules/admin/views/vip/vip
http://localhost:8085/index.php?r=admin/vip/vip/index

app\models\order\SoSheet
app\modules\admin\controllers\order\SoSheetController
@app/modules/admin/views/order/so-sheet
http://localhost:8085/index.php?r=admin/order/so-sheet/index

app\models\basic\PayType
app\modules\admin\controllers\basic\PayTypeController
@app/modules/admin/views/basic/pay-type
http://localhost:8085/index.php?r=admin/basic/pay-type/index

app\models\basic\DeliveryType
app\modules\admin\controllers\basic\DeliveryTypeController
@app/modules/admin/views/basic/delivery-type
http://localhost:8085/index.php?r=admin/basic/delivery-type/index

app\models\finance\VipWithdrawFlow
app\modules\admin\controllers\finance\VipWithdrawFlowController
@app/modules/admin/views/finance/vip-withdraw-flow
http://localhost:8085/index.php?r=admin/finance/vip-withdraw-flow/index

app\models\system\SheetType
app\modules\admin\controllers\system\SheetTypeController
@app/modules/admin/views/system/sheet-type
http://localhost:8085/index.php?r=admin/system/sheet-type/index

app\models\system\Parameter
app\modules\admin\controllers\system\ParameterController
@app/modules/admin/views/system/parameter
http://localhost:8085/index.php?r=admin/system/parameter/index


--api module
app\modules\api\Module
http://localhost:8085/index.php?r=api/default/index

app\modules\sale\Module
http://localhost:8085/index.php?r=sale/default/index

crontab  -e

$this->registerJsFile("@web/js/jquery-11.js");
$this->registerCssFile("@web/js/jquery-11.css");


150609:
php表单：

普通模式：		
<form action="<?= Url::toRoute('vip-login/index')?>" class="form-wrap ajax-form" method="post">
			<fieldset>
				<div class="field">
					<input name="VipLoginForm[vip_no]" class="mobile" 
						placeholder="请输入手机号" data-role="mobile" type="tel" value=<?php echo $model->vip_no?>>
				</div>
				<div class="field">
					<input name="VipLoginForm[password]" class="mobile" 
						placeholder="请输入密码" data-role="mobile" type="tel" value=<?php echo $model->password?>>
				</div>
				
				<div class="btn-wrap">
					<input name="submit" class="btn btn-orange" id="submit" value="登录"
						type="submit"> <input name="url"
						value="L3dhcC5waHAvd2ViL2dvb2RzL2dpZC8xMjg5MS5odG1s" type="hidden">
				</div>
			</fieldset>
		</form>
		
ActiveForm模式：		
		<div class="form-wrap ajax-form">
		<?php $form = ActiveForm::begin(['action' => ['vip_login/login'],'method'=>'post',]); ?>
			<fieldset>
				<div class="field">
			<?= $form->field($model, 'vip_no')->textInput(['maxlength' => 10,'placeholder'=>'请输入手机号','class'=>'mobile'])?>
			</div>

				<div class="field">
   			<?= $form->field($model, 'password')->textInput(['maxlength' => 60,'placeholder'=>'请输入密码','class'=>'mobile'])?>
   			</div>
			</fieldset>
			<div class="btn-wrap">
	    	 <?= Html::submitButton('登录', ['class' => 'btn btn-orange'])?>
	    </div>
		<?php ActiveForm::end(); ?>
		</div>		

<?php var_dump($model->getErrors());?>
<?php foreach ($model->getErrors() as $value) {
    			echo $value;
    		}?>
    		
<?php $this->registerJs(
    '$("document").ready(function(){ alert("hi"); });'
);?>

http://172.16.33.252:8085/index.php

r=sale%2Fvip-order%2Fcontact

http://q.cnblogs.com/q/45695/



短信接口：
www.ihuyi.com

用户名：cf_zff  
密码：agpW7c
验证码登录地址：http://106.ihuyi.cn/a
这个是账号密码

cf_tiger_guo
123456


微信支付：
wiriclub@126.com 
密码 zff16888 


支付宝支付：
wiriclub@163.com 
密码 zff16888 

public function rules()
    {
        return [
            [['password','re_password','new_password'], 'string','min'=>6, 'max' => 16,'message'=>'{attribute}位数为6至16位'],
            [['phone'], 'unique','message'=>'{attribute}已经被占用了'],
            ['phone','match','pattern'=>'/^1[0-9]{10}$/','message'=>'{attribute}必须为1开头的11位纯数字'],
            [['phone','password'],'required','on'=>'login','message'=>'{attribute}不能为空'],
            ['re_password','compare','compareAttribute'=>'password','message'=>'两次密码不一致'],
        ];
    }
    

 150611：
 自定义404页面
 
 $userHost = Yii::$app->request->userHost; 
$userIP = Yii::$app->request->userIP;

echo $_REQUEST['r'];
echo Yii::$app->request->get('r');

alipay api url:
http://open.alipay.com/index.htm
https://openhome.alipay.com/doc/docIndex.htm?url=https://openhome.alipay.com/doc/viewKbDoc.htm?key=236698&type=cat

weixin api url:
http://pay.weixin.qq.com/wiki/doc/api/app.php?chapter=11_1

$model->addError('vip_no',$vip->getErrors('vip_no')[0]);

http://t.cn/RAjJtmz

http://172.16.33.252:8085/index.php?r=sale/vip-login/index
http://172.16.33.252:8085/index.php?r=api/product/index

150613:
//jquery android toast.

http://localhost:8085/index.php?r=sale%2Fproduct%2Fview&id=4

&XDEBUG_SESSION_START=ECLIPSE_DBGP&KEY=14340830204631

update t_delivery_type set code = 'shunfeng' where id = 1;
insert into t_delivery_type(code,name,status)values('debangwuliu','德邦物流',1);
insert into t_delivery_type(code,name,status)values('ems','EMS',1);
insert into t_delivery_type(code,name,status)values('shentong','申通快递',1);
insert into t_delivery_type(code,name,status)values('yuantong','圆通速递',1);
insert into t_delivery_type(code,name,status)values('yunda','韵达快运',1);




http://192.168.1.100:8085/index.php?r=sale%2Fvip-order%2Fconfirm&orderId=9

Yii::app()->getBaseUrl()



&XDEBUG_SESSION_START=ECLIPSE_DBGP&KEY=14345052594721

insert into t_app_release(name,upgrade_desc,ver_no,force_upgrade,app_path) values
('1.1','1.解决微信分享问题',1.1,0,'ecommerce-adr.apk');

/sale/alipay-direct/index

http://localhost:8085/index.php?r=api/api-test/index
http://localhost:8085/index.php?r=api/vip-register/ajax-index
TODO:http://localhost:8085/index.php?r=api/vip-register/check-registered
http://localhost:8085/index.php?r=api/vip-login/ajax-index
http://localhost:8085/index.php?r=api/vip-login/update-pwd
http://localhost:8085/images/sale/app_logo.png

http://localhost:8085/index.php?r=api/sys-feedback/create

http://localhost:8085/index.php?r=api/notify/index
http://localhost:8085/index.php?r=api/notify/view&id=10
http://localhost:8085/index.php?r=sale/notify/view&id=10

http://localhost:8085/index.php?r=api/ad-info/index
http://localhost:8085/index.php?r=api/ad-info/ad-url&image_url=pos1.jpg

http://localhost:8085/index.php?r=api/earn-guild/index
http://localhost:8085/index.php?r=api/earn-guild/view&id=1
http://localhost:8085/index.php?r=sale/earn-guild/view&id=1

http://localhost:8085/index.php?r=sale/vip-register/index&parent_vip_no=13724346621

http://localhost:8085/index.php?r=api/download-app/view-app&app_path=ecommerce-adr.apk
http://localhost:8085/index.php?r=api/download-app/ajax-view

http://localhost:8085/index.php?r=api/product/view&id=4
http://localhost:8085/index.php?r=api/product/index
http://localhost:8085/index.php?r=api/product/index&product_name=
http://localhost:8085/index.php?r=api/product-type/index
http://localhost:8085/index.php?r=api/product/photo-view&url=/upload/product/20150613/pos1.jpg

http://localhost:8085/index.php?r=sale/product/view&id=4
http://localhost:8085/index.php?r=sale/vip-order/add-contact&product_id=4

http://localhost:8085/index.php?r=api/sale-agreement/view
http://localhost:8085/index.php?r=api/sale-agreement/view-rights
http://localhost:8085/index.php?r=sale/sale-agreement/view
http://localhost:8085/index.php?r=sale/sale-agreement/view-rights

http://localhost:8085/index.php?r=api/vip/view&id=4
http://localhost:8085/index.php?r=api/vip-bank/view&vip_id=4
http://localhost:8085/index.php?r=api/vip-bank/create
http://localhost:8085/index.php?r=api/vip-bank/update
http://localhost:8085/index.php?r=api/vip-bank/bank-list
http://localhost:8085/index.php?r=api/vip/update

http://localhost:8085/index.php?r=api/vip-income/view&vip_id=4

http://localhost:8085/index.php?r=api/vip-income-detail/view&id=4
http://localhost:8085/index.php?r=api/vip-income-detail/index&vip_id=4

http://localhost:8085/index.php?r=api/vip-withdraw-flow/index&vip_id=1
http://localhost:8085/index.php?r=api/vip-withdraw-flow/view&id=4
http://localhost:8085/index.php?r=api/vip-withdraw-flow/create

http://172.16.33.252:8085/index.php?r=api/vip/children&vip_id=1

http://localhost:8085/index.php?r=api/vip-order/group-index&vip_id=1
http://localhost:8085/index.php?r=api/vip-order/index&vip_id=18

http://172.16.33.252:8085/index.php?r=/api/sms/create

&XDEBUG_SESSION_START=ECLIPSE_DBGP&KEY=14346768324271

chmod -R 777 zff

http://120.24.245.164/index.php
http://120.24.245.164/index.php?r=api/download-app/view-app&app_path=ecommerce-adr-20150622.apk
http://120.24.245.164/upload/app/ecommerce-adr-20150622.apk
http://localhost:8085/download-app.php?app_path=ecommerce-adr-20150622.apk
http://120.24.245.164/download-app.php?app_path=ecommerce-adr-20150622.apk

http://localhost:8085/index.php?r=api/download-app/view-app&app_path=ecommerce-adr-20150622.apk

出错页面优化，不能直接报错Not Found (#404)，如输入链接http://localhost:8085/index.php?r=sale/product/view时

<?php echo floor($model['price']*100)/100?>
<?php for ($i=0;$i<count($detailList);$i++){
		$soDetail=$detailList
		?>
		
	<?php }?>

微信分享后，速度特别慢
循环出现空指针异常的问题。异常问题可以发送通过提示页面发送到供应商进行处理。
php定时任务

CREATE EVENT [IF NOT EXISTS] event_name
ON SCHEDULE schedule
[ON COMPLETION [NOT] PRESERVE]
[ENABLE | DISABLE]
[COMMENT 'comment']
DO sql_statement;



show variables like '%sche%'; 
SHOW VARIABLES LIKE 'event_scheduler';
/***execute with user root*/
set global event_scheduler =1; 

CREATE EVENT IF NOT EXISTS EVENT_AUTO_CANCEL_ORDER
ON SCHEDULE every 1 minute
ON COMPLETION  PRESERVE
COMMENT '订单提交24小时未支付，自动取消订单'
DO call pr_auto_cancel_order();


/**pr_auto_cancel_order***/
DROP procedure pr_auto_cancel_order;
DELIMITER $$
CREATE PROCEDURE `pr_auto_cancel_order` ()
/***
call pr_auto_cancel_order();
*/
BEGIN
	DECLARE  no_more_data,v_order_id INT DEFAULT 0;
	DECLARE v_order_date datetime ;
	
	DECLARE v_hours int;
	DECLARE cursor_order CURSOR FOR select id,order_date from t_so_sheet WHERE STATUS=3001 /*AND ID=?*/; 
	DECLARE CONTINUE HANDLER FOR NOT FOUND  SET  no_more_data = 1;

	select value into v_hours from t_sys_config where code = 'auto_cancel_order_hours';
    OPEN cursor_order;
	FETCH cursor_order INTO v_order_id,v_order_date;  
	REPEAT  
	if(timestampdiff(hour,v_order_date,now())>=v_hours) THEN
		UPDATE t_so_sheet SET status= 3006,memo='订单提交24小时未支付，自动取消订单' WHERE ID=v_order_id;
	END if;
	FETCH  cursor_order INTO v_order_id,v_order_date;  	
  
	UNTIL  no_more_data = 1  
	END REPEAT;  

	CLOSE cursor_order;  

END $$
DELIMITER ; 

select * from information_schema.events;
insert into t_sys_config(code,value,description)values('widthdraw_default_day',7,'可提现延迟天数，默认为7天');


支付接入、物流接入
根据状态，会员可以提交退货与取消订单的申请
退款单确认退款时，应该可以根据支付方式，将款项退还到相应的支付账户
提现与退款时，应该先修改提现申请单与退款单的状态，然后执行银行转账操作
android 产品购买的时候，对于特殊类别的商品，需要上传证件
团队订单中浏览订单的时候，滑动tab页的时候，订单数据丢失 ->ok
数据加载过程中，应该提示数据正在加载的数据框
微信与QQ中内嵌的浏览器不能下载附件的问题，可以根据判断浏览器类型，然后弹出一个遮挡窗口，提示在手机浏览器中打开
微信分享后，选择返回app时不能返回，只能按返回键进行返回。按返回键后，再次点击分享的时候，提示不能分享。
出现系统没有捕获的异常后，循环出现空指针异常的问题。异常问题可以通过提示页面发送到供应商进行处理。
出现系统异常后，不能正常退出应用；出现循环退出的情况。
申请网站域名并备案
快递查询API授权key申请
微信支付申请
支付宝支付申请
分享到微信、QQ、短信、朋友圈的内容格式确定 ->ok
分润计算算法详细说明
首页优化：首页增加底部导航，导航页内容待定
提现申请的时候，需要完善个人资料包括银行卡信息->ok
打开微信再回个人中心-我的资料里面报空指针异常->ok
增加结算退货门槛，具体内容待定
我的收入中“结算”按钮的名字改为“提现”，建议修改“结算”按钮的背景色->背景色未修改，文字已经修改。
我的收入中，“可结算金额”与“可提现金额”分开；增加“可提现金额”显示项，“可提现金额”根据“订单完成日期”与“提现延迟天数”来进行计算，“提现延迟天数”可配置。->ok
后台主页logo更换
销售页面日志记录 ->异常与出错日期未记录到数据库
移动端日志记录 ->ok
提示系统崩溃的页面要友好一点。
PullToRefreshListView分隔线条要细一点，底部没有分隔条，看起来不美观。->ok
WEB销售模块要增加顶部导航与底部导航
订单列表页面无数据要提示，不能显示空白页面。
收货地址列表与选择页面不美观，建议修改按钮样式。
横竖屏幕切换的时候，页面自动返回到个人中心。
页面统一增加返回按钮
等待效果美化，白色的等待页面不好看。
团队订单显示数据格式优化->ok
收入明细数据显示格式优化->ok
我的账单显示效果优化->ok
我的团队显示效果优化->ok
意见反馈提交后加入等待效果。->ok
联系我们内容居中显示，显示当前的app版本。->居中未实现，增加了版本号显示。
修改密码提交加入等待效果->ok
系统出现退出多次才能退出的情况
首页广告栏切换不平滑，不能循环滚动
我的消息中加入发布时间，PullToRefreshListView行号要加大。
二维码可以保存为本地图片，通过发送二维码发展下级会员。
订单状态跟踪推送、会员升级消息推送（短信与app冒泡提醒）
订单取消与确认收货处理，订单退货退款处理。
web浏览器横竖屏切换时，不能改变当前浏览的URL。

提现申请审核后，修改表t_vip_income：
表t_vip_withdraw_flow.status中0->1时；
t_vip_income.can_settle_amt = t_vip_income.can_settle_amt - t_vip_withdraw_flow.settled_amt;
t_vip_income.scan_withdraw_amt = t_vip_income.can_withdraw_amt - t_vip_withdraw_flow.settled_amt;
t_vip_income.settled_amt = t_vip_income.settled_amt + t_vip_withdraw_flow.settled_amt;

表t_vip_withdraw_flow.status中1->0时；
t_vip_income.can_settle_amt = t_vip_income.can_settle_amt + t_vip_withdraw_flow.settled_amt;
t_vip_income.scan_withdraw_amt = t_vip_income.can_withdraw_amt + t_vip_withdraw_flow.settled_amt;
t_vip_income.settled_amt = t_vip_income.settled_amt - t_vip_withdraw_flow.settled_amt;

<?php require '../layouts/footer.php';?>
crontab -h
crontab -e
https://www.centos.bz/2011/07/php-cron-job-linux-crontab/

/***grant create trigger auth**/
SET GLOBAL log_bin_trust_function_creators = 1;
/**tr_so_sheet_update_status**/
DROP trigger tr_so_sheet_update_status;
DELIMITER $$
create trigger tr_so_sheet_update_status after update on t_so_sheet for each row  
/***
	update t_so_sheet.status
*/
begin
	declare v_so_status int;
	if (new.status=	3005 and old.status<>3005) then
		update t_vip_operation_log set op_os_type=CONCAT(old.status,'=>',new.status)  where id = 54;
	elseif (new.status<> 3005 and old.status=3005) then
		update t_vip_operation_log set op_os_type=CONCAT(old.status,'=>',new.status)  where id = 54;
	end if;
end;
$$
DELIMITER ; 



/**pr_recompute_vip_income***/
DROP procedure pr_recompute_vip_income;
DELIMITER $$
CREATE PROCEDURE `pr_recompute_vip_income` (in p_order_id int,in p_add_minus int)
/***
p_order_id:订单编号
p_add_minus: 1:增加可提现金额；0:减少可提现金额
call pr_recompute_vip_income();
*/
BEGIN
	DECLARE  no_more_data,v_order_id,v_product_id,v_vip_id,v_special_deduct_flag INT DEFAULT 0;
	declare v_quantity decimal(6,0);
	declare v_price,v_amount decimal(20,6);
	DECLARE v_order_date datetime ;
	/**t_deduct_regular,订单表中要增加订单完成日期**/	
	declare v_deduct_level1,v_deduct_level2,v_deduct_level3,v_deduct_level4 decimal(14,2);		
	
	DECLARE cursor_order CURSOR FOR select so.id,so.vip_id,so.order_date,detail.product_id,detail.quantity,detail.price,detail.amount 
	from t_so_sheet so,t_so_detail detail WHERE so.id= detail.order_id and so.id=p_order_id; 
	DECLARE CONTINUE HANDLER FOR NOT FOUND  SET  no_more_data = 1;
	
	/***get deduct values*/
	select deduct_level1,deduct_level2,deduct_level3,deduct_level4  
	into v_deduct_level1,v_deduct_level2,v_deduct_level3,v_deduct_level4 
	from t_deduct_regular limit 0,1;

    OPEN cursor_order;
	FETCH cursor_order INTO v_order_id,v_vip_id,v_order_date,v_product_id,v_quantity,v_price,v_amount;  
	REPEAT  	
	
		/* select * from t_product***/
		select special_deduct_flag into v_special_deduct_flag 	from t_product where id = v_product_id;
		if(special_deduct_flag=1)then
			select deduct_level1,deduct_level2,deduct_level3,deduct_level4  
			into v_deduct_level1,v_deduct_level2,v_deduct_level3,v_deduct_level4 
			from t_product where id = v_product_id;
		end if;
		
		/***get vip levels**/

		if(timestampdiff(hour,v_order_date,now())>=v_hours) THEN
			/*** t_vip_income_detail,t_vip_income*/	
			select 'a';

		END if;
		FETCH cursor_order INTO v_order_id,v_vip_id,v_order_date,v_product_id,v_quantity,v_price,v_amount;  
	  
		UNTIL  no_more_data = 1  
	END REPEAT;  

	CLOSE cursor_order;  

END $$
DELIMITER ; 

